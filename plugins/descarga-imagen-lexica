import fetch from 'node-fetch'
import { checkReg } from '../lib/checkReg.js'

let handler = async (m, { conn, text, usedPrefix, command }) => {
  // 1. VerificaciÃ³n de registro (Estilo KarBot) ğŸŒ¿
  let who = m.quoted ? m.quoted.sender : m.mentionedJid && m.mentionedJid[0] ? m.mentionedJid[0] : m.sender
  let user = global.db.data.users[who]
  if (await checkReg(m, user)) return

  // 2. ValidaciÃ³n de texto
  if (!text) {
    return conn.reply(m.chat, `> Â¿QuÃ© estilo de arte deseas buscar hoy, cielo?`, m)
  }

  // 3. Secuencia de reacciones botÃ¡nicas ğŸ”ğŸŒ¿ğŸ€ğŸ–¼ï¸
  const reacciones = ['ğŸ”', 'ğŸŒ¿', 'ğŸ€', 'ğŸ–¼ï¸']
  for (const reacc of reacciones) {
    await m.react(reacc)
  }

  try {
    const apiUrl = `https://api-aswin-sparky.koyeb.app/api/search/imageai?search=${encodeURIComponent(text)}`
    const res = await fetch(apiUrl)
    
    if (!res.ok) throw new Error()
    const json = await res.json()

    if (!json.status || !json.data || json.data.length < 2) throw new Error()

    // Seleccionamos las dos primeras joyas artÃ­sticas del array
    const img1 = json.data[0]
    const img2 = json.data[1]

    // --- ENVÃO DE LA PRIMERA IMAGEN ---
    await conn.sendMessage(m.chat, {
      image: { url: img1 },
      caption: `> Imagen 1 encontrada en calidad: *Original*`
    }, { quoted: m })

    // --- ENVÃO DE LA SEGUNDA IMAGEN ---
    await conn.sendMessage(m.chat, {
      image: { url: img2 },
      caption: `> Imagen 2 encontrada en calidad: *Original*`
    }, { quoted: m })

    // El sello final de nuestra ingenierÃ­a âš™ï¸
    await m.react('âš™ï¸')

  } catch (error) {
    await m.react('âŒ')
    return conn.reply(m.chat, `> Lo siento, no pude encontrar las imÃ¡genes`, m)
  }
}

handler.help = ['lexica + texto (img)']
handler.tags = ['downloader']  
handler.command = /^(lexica|art|look|findart)$/i
handler.group = true

export default handler